<!DOCTYPE html>
<html>

<head>
    <title>d3.js with leaflet.js</title>

    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7/leaflet.css" />
    <script src="http://d3js.org/d3.v3.min.js"></script>

    <script src="http://cdn.leafletjs.com/leaflet-0.7/leaflet.js">
    </script>

</head>

<body>

    <div id="map" style="width: 900px; height: 600px"></div>

    <script type="text/javascript">
        const map = L.map("map").setView([43.42, -3.7944], 10);
        L.tileLayer("http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

        /* Initialize the SVG layer */
        map._initPathRoot();

        /* We simply pick up the SVG from the map object */
        var svg = d3.select("#map").select("svg");
        var g = svg.append("g");

        /**
         * Coordenada en mapa para pintar en SVG
         * @param   {L.LatLng} latlon - objeto punto longitud / latitud
         * @returns {L.Point} - punto con coordenadas x, y en píxels
         */
        function point2map(latlon) {
            return map.latLngToLayerPoint(latlon);
        }

        /**
         * Genera un path SVG para cada punto, con una longitud 'inventada'
         * @param {L.LatLng} pto - punto  origen
         */
        function lineaVector(pto) {
            let malla = 0.0083 * 2.0; // ancho malla, en grados decimales (aprox. 2km)
            let p = point2map(pto); // origen
            let p2 = point2map(new L.latLng(pto.lat + malla, pto.lng + malla)) // destino, a 45º
            let x0 = p.x;
            let y0 = p.y;
            let x1 = p2.x;
            let y1 = p2.y;

            let e = `M ${x0} ${y0} L ${x1} ${y1}`
            return e;
        }

        //pintarCirculosTest();

        d3.csv("puntos.csv", function (data) {
            let ptos = data.map(function (d) {
                d.latlon = new L.latLng(+d.lat, +d.lon);
                return d;
            });

            let feature = g.selectAll("path")
                .data(ptos)
                .enter()
                .append("path")
                .attr("d", function (d) {
                    return lineaVector(d.latlon)
                })
                .style("stroke-width", 3)
                .style("stroke", "steelblue")
                .style("fill", "none");;

            map.on("viewreset", update);
            update();

            function update() {
                feature.attr("d", function (d) {
                    return lineaVector(d.latlon)
                });
            }
        });

        /**
         * Función test pintado
         */
        function pintarCirculosTest() {
            /* Pintado de circulos - TEST */
            d3.json("circles.json", function (collection) {
                collection.objects.forEach(function (d) {
                    d.LatLng = new L.LatLng(d.circle.coordinates[0],
                        d.circle.coordinates[1])
                })

                var feature = g.selectAll("circle")
                    .data(collection.objects)
                    .enter().append("circle")
                    .style("stroke", "black")
                    .style("opacity", .6)
                    .style("fill", "red")
                    .attr("r", 20);

                map.on("viewreset", update);
                update();

                function update() {
                    feature.attr("transform",
                        function (d) {
                            return "translate(" +
                                map.latLngToLayerPoint(d.LatLng).x + "," +
                                map.latLngToLayerPoint(d.LatLng).y + ")";
                        }
                    )
                }
            });
        }
    </script>
</body>

</html>

<!-- 
    * REFERENCIAS 
    https://bost.ocks.org/mike/leaflet/
-->
