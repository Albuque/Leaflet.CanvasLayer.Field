<!DOCTYPE html>
<html>

<head>
    <title>d3.js with leaflet.js</title>

    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7/leaflet.css" />
    <script src="http://d3js.org/d3.v3.min.js"></script>

    <script src="http://cdn.leafletjs.com/leaflet-0.7/leaflet.js">
    </script>

</head>

<body>

    <div id="map" style="width: 900px; height: 600px"></div>

    <script type="text/javascript">
        var map = L.map('map').setView([43.42, -3.7944], 10);
        L.tileLayer(
            'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 10,
            }).addTo(map);

        /* Initialize the SVG layer */
        map._initPathRoot();

        /* We simply pick up the SVG from the map object */
        var svg = d3.select("#map").select("svg");
        var g = svg.append("g");


        //pintarCirculosTest();

        d3.csv('puntos.csv', function (data) {

            var ptos = data.map(function (d) {
                d.latlon = [+d.lat, +d.lon];
                return d;
            });

            var feature = g.selectAll("line")
                .data(ptos)
                .enter().append("line")
                .style("stroke", "brown")
                .attr('stroke-width', 4)
                .attr("x1", function (d) {
                    return point2map(d.latlon).x
                })
                .attr("y1", function (d) {
                    return point2map(d.latlon).y
                })
                .attr("x2", function (d) {
                    return point2map(d.latlon).x - 150
                })
                .attr("y2", function (d) {
                    return point2map(d.latlon).y - 150
                })

            map.on("viewreset", update);
            update();


            function point2map(latlon) {
                return map.latLngToLayerPoint(latlon);
            }


            function update() {
                /*    feature.attr("transform",
                        function (d) {
                            return "translate(" +
                                map.latLngToLayerPoint(d.latlon).x + "," +
                                map.latLngToLayerPoint(d.latlon).y + ")";
                        }
                    )
                */
            }
        });

        /**
         * Funci√≥n test pintado
         */
        function pintarCirculosTest() {
            /* Pintado de circulos - TEST */
            d3.json("circles.json", function (collection) {
                collection.objects.forEach(function (d) {
                    d.LatLng = new L.LatLng(d.circle.coordinates[0],
                        d.circle.coordinates[1])
                })

                var feature = g.selectAll("circle")
                    .data(collection.objects)
                    .enter().append("circle")
                    .style("stroke", "black")
                    .style("opacity", .6)
                    .style("fill", "red")
                    .attr("r", 20);

                map.on("viewreset", update);
                update();

                function update() {
                    feature.attr("transform",
                        function (d) {
                            return "translate(" +
                                map.latLngToLayerPoint(d.LatLng).x + "," +
                                map.latLngToLayerPoint(d.LatLng).y + ")";
                        }
                    )
                }
            });
        }
    </script>
</body>

</html>

<!-- 
    * REFERENCIAS 
    https://bost.ocks.org/mike/leaflet/
-->
